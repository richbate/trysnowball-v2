#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Analytics Protection Pre-commit Hook
echo "ğŸ” Running analytics protection checks..."

# Check if CSP-related files have been modified
if git diff --cached --name-only | grep -E "(public/_headers|public/index.html)"; then
  echo "ğŸ“‹ CSP files modified - validating analytics compatibility..."
  
  # Run CSP validation
  node scripts/validate-csp.js
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ COMMIT BLOCKED: CSP changes would break Google Analytics"
    echo "ğŸš¨ Analytics are CRITICAL for business - please fix CSP before committing"
    echo ""
    echo "Common fixes:"
    echo "  â€¢ Ensure https://www.googletagmanager.com is in script-src"
    echo "  â€¢ Ensure https://*.google-analytics.com is in connect-src"
    echo "  â€¢ Run 'node scripts/validate-csp.js' for detailed validation"
    echo ""
    exit 1
  fi
  
  echo "âœ… CSP validation passed - analytics will continue working"
fi

# Run standard linting
echo "ğŸ” Running linter..."
npm run lint

# Run tests related to analytics
echo "ğŸ§ª Running analytics tests..."
npm test -- --testPathPattern=analytics --watchAll=false

echo "âœ… All pre-commit checks passed!"