<!DOCTYPE html>
<html>
<head>
    <title>Clean UK Debt API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .form-group { margin: 15px 0; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        .output { background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 20px 0; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .debt-item { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Clean UK Debt API Test</h1>
        <p>Testing the new bulletproof, boring debt API with zero conversions</p>

        <!-- Form to create debt -->
        <div class="form-group">
            <h3>Create New Debt</h3>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="name" placeholder="Barclaycard" />
            </div>
            <div class="form-group">
                <label>Amount (¬£):</label>
                <input type="number" id="amount" step="0.01" min="0" placeholder="1234.56" />
            </div>
            <div class="form-group">
                <label>Original Amount (¬£):</label>
                <input type="number" id="original_amount" step="0.01" min="0" placeholder="5000.00" />
            </div>
            <div class="form-group">
                <label>APR (%):</label>
                <input type="number" id="apr" step="0.1" min="0" max="100" placeholder="19.9" />
            </div>
            <div class="form-group">
                <label>Min Payment (¬£):</label>
                <input type="number" id="min_payment" step="0.01" min="0" placeholder="45.00" />
            </div>
            <div class="form-group">
                <label>Credit Limit (¬£):</label>
                <input type="number" id="debt_limit" step="0.01" min="0" placeholder="5000.00" />
            </div>
            <div class="form-group">
                <label>Debt Type:</label>
                <select id="debt_type">
                    <option value="credit_card">Credit Card</option>
                    <option value="loan">Loan</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Order Index:</label>
                <input type="number" id="order_index" step="1" min="0" placeholder="0" />
            </div>
            <button onclick="createDebt()">Create Debt</button>
        </div>

        <!-- Actions -->
        <div>
            <button onclick="fetchDebts()">üìã Fetch All Debts</button>
            <button onclick="clearOutput()">üßπ Clear Output</button>
            <button onclick="testValidation()">‚úÖ Test Validation</button>
        </div>

        <!-- Output -->
        <div id="output" class="output">Ready to test clean API...</div>

        <!-- Current debts display -->
        <div id="debts-display" style="margin-top: 20px;"></div>
    </div>

    <script>
        let currentDebts = [];
        const output = document.getElementById('output');
        const debtsDisplay = document.getElementById('debts-display');

        function log(message) {
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.textContent = 'Output cleared...\n';
        }

        async function apiCall(endpoint, options = {}) {
            try {
                // Get token (you'll need to be logged in)
                const token = localStorage.getItem('token') || 'test-token';
                
                const response = await fetch(endpoint, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch {
                        // Use default
                    }
                    throw new Error(errorMessage);
                }

                return await response.json();
            } catch (error) {
                log('‚ùå API Error: ' + error.message);
                throw error;
            }
        }

        async function fetchDebts() {
            log('üìã Fetching all debts...');
            try {
                const debts = await apiCall('/api/debts');
                log('‚úÖ Fetched ' + debts.length + ' debts');
                log('üìä Raw response: ' + JSON.stringify(debts, null, 2));
                
                currentDebts = debts;
                displayDebts(debts);
            } catch (error) {
                log('‚ùå Failed to fetch debts');
            }
        }

        async function createDebt() {
            log('üìù Creating new debt...');
            
            const debtData = {
                name: document.getElementById('name').value || null,
                amount: parseFloat(document.getElementById('amount').value) || 0,
                original_amount: document.getElementById('original_amount').value ? parseFloat(document.getElementById('original_amount').value) : null,
                apr: parseFloat(document.getElementById('apr').value) || 0,
                min_payment: parseFloat(document.getElementById('min_payment').value) || 0,
                debt_limit: document.getElementById('debt_limit').value ? parseFloat(document.getElementById('debt_limit').value) : null,
                debt_type: document.getElementById('debt_type').value,
                order_index: parseInt(document.getElementById('order_index').value) || 0,
            };

            log('üì§ Payload: ' + JSON.stringify(debtData, null, 2));

            try {
                const newDebt = await apiCall('/api/debts', {
                    method: 'POST',
                    body: JSON.stringify(debtData),
                });
                
                log('‚úÖ Created debt with ID: ' + newDebt.id);
                log('üìä Full debt object: ' + JSON.stringify(newDebt, null, 2));
                
                // Clear form
                document.getElementById('name').value = '';
                document.getElementById('amount').value = '';
                document.getElementById('original_amount').value = '';
                document.getElementById('apr').value = '';
                document.getElementById('min_payment').value = '';
                document.getElementById('debt_limit').value = '';
                document.getElementById('order_index').value = '';
                
                // Refresh debt list
                await fetchDebts();
                
            } catch (error) {
                log('‚ùå Failed to create debt');
            }
        }

        function displayDebts(debts) {
            if (debts.length === 0) {
                debtsDisplay.innerHTML = '<p>No debts found</p>';
                return;
            }

            let html = '<h3>Current Debts</h3>';
            debts.forEach(debt => {
                html += `
                    <div class="debt-item">
                        <strong>${debt.name}</strong> - ¬£${debt.amount}
                        <br>APR: ${debt.apr}% | Min Payment: ¬£${debt.min_payment}
                        <br>Type: ${debt.debt_type} | Order: ${debt.order_index}
                        <br><small>ID: ${debt.id}</small>
                        <button onclick="deleteDebt('${debt.id}')" class="danger" style="float: right; margin-top: -40px;">Delete</button>
                    </div>
                `;
            });
            debtsDisplay.innerHTML = html;
        }

        async function deleteDebt(id) {
            if (!confirm('Delete this debt?')) return;
            
            log('üóëÔ∏è Deleting debt: ' + id);
            try {
                await apiCall(`/api/debts/${id}`, { method: 'DELETE' });
                log('‚úÖ Deleted debt: ' + id);
                await fetchDebts();
            } catch (error) {
                log('‚ùå Failed to delete debt');
            }
        }

        function testValidation() {
            log('‚úÖ Testing validation...');
            
            // Test invalid data
            const badData = {
                name: '',
                amount: -100,
                apr: 150,
                min_payment: 'not a number',
                debt_type: null,
                order_index: 3.14
            };
            
            log('üì§ Testing with invalid data: ' + JSON.stringify(badData, null, 2));
            
            apiCall('/api/debts', {
                method: 'POST',
                body: JSON.stringify(badData),
            }).then(result => {
                log('‚ùå Validation failed - should have rejected this!');
            }).catch(error => {
                log('‚úÖ Validation working - rejected bad data: ' + error.message);
            });
        }

        // Auto-fetch debts on load
        setTimeout(fetchDebts, 1000);
    </script>
</body>
</html>