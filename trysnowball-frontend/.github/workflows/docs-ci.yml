name: 📚 Documentation CI

on:
  push:
    paths:
      - '**/*.md'
      - '.github/workflows/docs-ci.yml'
  pull_request:
    paths:
      - '**/*.md'

jobs:
  docs-validation:
    name: 📋 Docs Validation
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 📝 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: npm ci

      - name: 🔍 Lint Markdown
        run: |
          npx markdownlint-cli2 "**/*.md" "#node_modules"

      - name: 🔗 Check Links
        run: |
          npx lychee --no-progress --max-redirects 3 "docs/**/*.md" "*.md" || true

      - name: 🚫 Check Forbidden Patterns in Docs
        run: |
          echo "🔍 Scanning documentation for forbidden patterns..."
          
          # Check for .data access (should only be in "Don't do this" sections)
          DIRECT_DATA=$(grep -rE "debtsManager\.data|authManager\.data|settingsManager\.data" . --include="*.md" --exclude-dir=node_modules | grep -v "❌\|Don't\|NEVER\|FORBIDDEN" || true)
          if [ -n "$DIRECT_DATA" ]; then
            echo "❌ Found .data access outside of 'Don't do this' examples:"
            echo "$DIRECT_DATA"
            exit 1
          fi
          
          # Check for localStorage patterns (should only be in forbidden examples)
          LOCALSTORAGE_USAGE=$(grep -rE "localStorage\.(setItem|getItem).*(debt|theme|analytics)" . --include="*.md" --exclude-dir=node_modules | grep -v "❌\|Forbidden\|Don't\|NEVER" || true)
          if [ -n "$LOCALSTORAGE_USAGE" ]; then
            echo "❌ Found localStorage patterns outside of forbidden examples:"
            echo "$LOCALSTORAGE_USAGE"
            exit 1
          fi
          
          # Check for beta references (should only be in CI lists)
          BETA_REFS=$(grep -rE "(betaEnabled|useBetaGate|BetaGateWrapper|UpgradeLifetime)" . --include="*.md" --exclude-dir=node_modules | grep -v "CHANGELOG\|FOLLOW_UPS\|PR_DESCRIPTION\|forbidden" || true)
          if [ -n "$BETA_REFS" ]; then
            echo "❌ Found beta references outside of CI documentation:"
            echo "$BETA_REFS"
            exit 1
          fi
          
          echo "✅ All documentation patterns are safe!"

      - name: 🧪 Run Docs Smoke Test
        run: ./scripts/docs-smoke.sh